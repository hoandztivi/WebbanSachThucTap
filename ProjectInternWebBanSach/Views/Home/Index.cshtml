@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Trang chủ";
}

<link rel="stylesheet" href="~/css/index.css" asp-append-version="true" />

<!-- Banner Carousel -->
<div class="banner-carousel relative overflow-hidden mb-8">
    <div class="carousel-container flex transition-transform duration-500 ease-in-out">
        @foreach (var banner in (IEnumerable<dynamic>)ViewBag.Banners)
        {
            <div class="carousel-slide min-w-full relative">
                <a href="@banner.LienKet">
                    <img src="@banner.HinhAnh"
                         alt="@banner.TieuDe"
                         class="w-full h-64 md:h-96 lg:h-[500px] object-cover" />
                </a>
                @if (!string.IsNullOrEmpty((string)banner.MoTa))
                {
                    <div class="absolute bottom-4 left-6 bg-black/60 text-white px-4 py-2 rounded-lg text-sm md:text-base">
                        @banner.MoTa
                    </div>
                }
            </div>
        }
    </div>
</div>

<div class="container mx-auto px-4 py-10 max-w-7xl">

    @* --------- SÁCH MỚI NHẤT (5 cuốn) --------- *@
    @{
        var newBooks = ViewBag.NewBooks as IEnumerable<dynamic>;
    }
    @if (newBooks != null && newBooks.Any())
    {
        <section class="mb-12">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 uppercase inline-block border-b-4 border-red-500 pb-1">
                    Sách mới nhất
                </h2>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                @foreach (var p in newBooks)
                {
                    decimal gia = 0m, giam = 0m;
                    try { if (p?.Gia != null) gia = Convert.ToDecimal(p.Gia); } catch { }
                    try { if (p?.GiamGia != null) giam = Convert.ToDecimal(p.GiamGia); } catch { }
                    var currentPrice = Math.Max(0m, gia - giam);
                    var showOld = giam > 0m && currentPrice < gia;

                    <div class="product-card">
                        <a href="@Url.Action("Details", "Products", new { id = p.MaSach })" class="block">
                            <div class="relative aspect-[3/4] bg-gray-100 overflow-hidden">
                                @if (giam > 0)
                                {
                                    <div class="discount-badge">@string.Format("-{0:N0}đ", giam)</div>
                                }
                                <img src="@p.HinhAnh" alt="@p.TieuDe"
                                     class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                                     loading="lazy" />
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="title">@p.TieuDe</h3>
                                <div class="flex items-center gap-2 flex-wrap mt-1">
                                    <span class="price text-red-600 font-bold text-base md:text-lg">
                                        @string.Format("{0:N0}đ", currentPrice)
                                    </span>
                                    @if (showOld)
                                    {
                                        <span class="old-price text-gray-400 text-xs md:text-sm line-through">
                                            @string.Format("{0:N0}đ", gia)
                                        </span>
                                    }
                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </section>
    }

    @* --------- DANH SÁCH THỂ LOẠI (mỗi thể loại 5 sách) --------- *@
    @foreach (var cat in Model)
    {
        <section class="mb-12">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 uppercase inline-block border-b-4 border-red-500 pb-1">
                    @cat.TheLoai.TenTheLoai
                </h2>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                @foreach (var product in cat.Sach)
                {
                    decimal gia = (decimal)(product.Gia ?? 0m);
                    decimal giam = (decimal)(product.GiamGia ?? 0m);
                    var currentPrice = Math.Max(0m, gia - giam);
                    var showOld = giam > 0m && currentPrice < gia;

                    <div class="product-card">
                        <a href="@Url.Action("Details", "Products", new { id = product.MaSach })" class="block">
                            <div class="relative aspect-[3/4] bg-gray-100 overflow-hidden">
                                @if (giam > 0)
                                {
                                    <div class="discount-badge">@string.Format("-{0:N0}đ", giam)</div>
                                }
                                <img src="@product.HinhAnh"
                                     alt="@product.TieuDe"
                                     class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                                     loading="lazy" />
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="title">@product.TieuDe</h3>
                                <div class="flex items-center gap-2 flex-wrap mt-1">
                                    <span class="price text-red-600 font-bold text-base md:text-lg">
                                        @string.Format("{0:N0}đ", currentPrice)
                                    </span>
                                    @if (showOld)
                                    {
                                        <span class="old-price text-gray-400 text-xs md:text-sm line-through">
                                            @string.Format("{0:N0}đ", gia)
                                        </span>
                                    }
                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <div class="text-center mt-6">
                <a href="@Url.Action("TheoTheLoai", "Products", new { id = cat.TheLoai.MaTheLoai })"
                   class="inline-block text-red-600 hover:text-red-700 font-medium text-sm md:text-base transition">
                    Xem thêm >>
                </a>
            </div>
        </section>
    }

    @* --------- PHÂN TRANG THỂ LOẠI --------- *@
    @{
        var pg = ViewBag.Pagination;
        if (pg != null)
        {
            int current = (int)pg.Current;
            int total = (int)pg.TotalPages;
            bool hasPrev = (bool)pg.HasPrev;
            bool hasNext = (bool)pg.HasNext;

            if (total > 1)
            {
                <div class="mt-8 flex items-center justify-center gap-2 select-none">
                    <a class="px-3 py-2 rounded border text-sm transition @(hasPrev ? "hover:bg-gray-50 border-gray-300 text-gray-700" : "opacity-40 cursor-not-allowed border-gray-200 text-gray-400")"
                       href="@(hasPrev ? Url.Action("Index", "Home", new { page = current - 1 }) : "#")">
                        ‹ Trang trước
                    </a>

                    @{
                        var start = Math.Max(1, current - 2);
                        var end = Math.Min(total, current + 2);
                        for (int i = start; i <= end; i++)
                        {
                            <a class="px-3 py-2 rounded border text-sm transition @(i == current ? "bg-red-600 text-white border-red-600" : "hover:bg-gray-50 border-gray-300 text-gray-700")"
                               href="@(i == current ? "#" : Url.Action("Index", "Home", new { page = i }))">
                                @i
                            </a>
                        }
                    }

                    <a class="px-3 py-2 rounded border text-sm transition @(hasNext ? "hover:bg-gray-50 border-gray-300 text-gray-700" : "opacity-40 cursor-not-allowed border-gray-200 text-gray-400")"
                       href="@(hasNext ? Url.Action("Index", "Home", new { page = current + 1 }) : "#")">
                        Trang sau ›
                    </a>
                </div>
            }
        }
    }
</div>

<script src="~/js/index.js" asp-append-version="true"></script>
